<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Man-in-the-middle per tutti con Bettercap – Alessandro Pagiaro</title> <meta name="description" content="Studente di Informatica presso l'Università di Pisa. Scout a tempo perso."> <meta name="keywords" content="crittografia, MITM, sicurezza, bettercap"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://www.bettercap.org/assets/logo.png"> <meta name="twitter:title" content="Man-in-the-middle per tutti con Bettercap"> <meta name="twitter:description" content="Due/tre cosine spiegate su Bettercap"> <meta name="twitter:site" content="@alessandro308"> <meta name="twitter:creator" content="@alessandro308"> <!-- Open Graph --> <meta property="og:locale" content="it_IT"> <meta property="og:type" content="article"> <meta property="og:title" content="Man-in-the-middle per tutti con Bettercap"> <meta property="og:description" content="Due/tre cosine spiegate su Bettercap"> <meta property="og:url" content="https://apagiaro.it/bettercap-guida-ita/"> <meta property="og:site_name" content="Alessandro Pagiaro"> <meta property="og:image" content="https://apagiaro.it/assets/img/me.png"> <link rel="canonical" href="https://apagiaro.it/bettercap-guida-ita/"> <link href="https://apagiaro.it/feed.xml" type="application/atom+xml" rel="alternate" title="Alessandro Pagiaro Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://apagiaro.it/assets/css/main.css"> <!-- JS --> <script src="https://apagiaro.it/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://apagiaro.it/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://apagiaro.it/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://apagiaro.it/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://apagiaro.it/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://apagiaro.it/favicon.png"> <link rel="shortcut icon" href="https://apagiaro.it/favicon.ico"> <!-- Background Image --> <!-- Post Feature Image --> <style type="text/css">.feature {background-image:url(https://www.bettercap.org/assets/logo.png);}</style> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://apagiaro.it/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://apagiaro.it/assets/img/me.png" alt="Alessandro Pagiaro photo" class="author-photo"> <h4>Alessandro Pagiaro</h4> <p>Studente di Informatica presso l'Università di Pisa. Scout a tempo perso.</p> </li> <li><a href="https://apagiaro.it/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:alessandropagiaro@gmail.com" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://twitter.com/alessandro308" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://linkedin.com/in/alessandro-pagiaro-9a5a5496" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/alessandro308" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://apagiaro.it/posts/">All Posts</a></li> <li><a href="https://apagiaro.it/tags/">All Tags</a></li> </ul> </li> <li><a href="https://apagiaro.it/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Man-in-the-middle per tutti con Bettercap</h1> <h4>24 Aug 2017</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~9 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://apagiaro.it/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>Una delle cose che ci si immagina, quando si pensa alla sicurezza informatica, è l’intercettare e modificare il traffico internet di un computer <em>target</em> per fare quello che ci occorre.</p> <div class="notice"> <h3>Attenzione!!!</h3> Blocchiamoci un attimo prima di fare qualsiasi cosa, se intercettate traffico o vi immettete in una rete di cui non avete l'autorizzazione, state facendo, come dire, un bel reato penale! Ci sono tante cose legali per cui uno potrebbe trovare utile queste cose, come ad esempio: <ul> <li>Reverse engineering per verificare dei protocolli di rete</li> <li>Controllare la sicurezza di alcuni dispositivi IoT</li> <li>Provare ad analizzare il traffico del network</li> <li>NON per hackerare il profilo Facebook del vicino</li> </ul> </div> <p>L’idea di questa guida è spiegare quindi come fare per intercettare il traffico della rete wifi a cui uno è connesso per poi poterlo analizzare in vari modi (e gestire il tutto, magari, tramite delle politiche QoS specifiche). Se non ti serve analizzare le reti potresti comunque trovare questa guida divertente ma, come sempre, occhio a come utilizzi questa cosa!</p> <p><img src="https://www.bettercap.org/assets/logo.png" alt="Bettercap Logo"></p> <h1 id="bettercap-potenza-e-semplicità">Bettercap: potenza e semplicità</h1> <p>Lo strumento che andremo ad utilizzare è Bettercap, sviluppato da <a href="https://github.com/evilsocket">EvilSocket</a>, uno sviluppatore italiano. La descrizione sul ufficiale è</p> <p><em>BetterCAP is a powerful, flexible and portable tool created to perform various types of MITM attacks against a network, manipulate HTTP, HTTPS and TCP traffic in realtime, sniff for credentials and much more.</em></p> <p>Insomma, è un bell’oggettino per fare man-in-the-middle (MITM) con pochi comandi da terminale, nel mio caso, divertirsi un po’ tra coinquilini e farsi <em>code injection</em> a vicenda.</p> <p>A questo punto, se ne sai un pochino di reti, vai direttamente sul <a href="https://www.bettercap.org">sito ufficiale</a> che ti risulterà più veloce di questa guida, altrimenti continua pure…</p> <p><img src="https://www.cyberciti.biz/media/new/tips/2007/08/linux-internet-model-network-stack.gif" alt="Network Layers"></p> <h1 id="come-sono-fatte-le-reti">Come sono fatte le reti</h1> <p>Innanzitutto occorre dire qualche cosina sulle reti. Parlavo con un mio amico che mi chiedeva <strong>se, analizzando le onde radio che passavano vicino al mio computer, fossi in grado di vedere cosa gli altri stessero facendo.</strong></p> <p>Ma certo… Aprite Wireshark, analizzate i pacchetti wifi e… E chiaramente non vedete nulla di interessante, solo numeri e lettere a caso! Questo perchè, fortunatamente, tutto il traffico che il nostro pc scambia con il router è per lo più cifrato. Dico per lo più perchè poi dipende da 3000 fattori, ma la maggior parte dei router che usiamo, utilizzano come metodo di sicurezza della password il protocollo WPA-qualcosa e quindi il traffico è cifrato.</p> <p>“Ah, bene!”, ha detto il mio amico, <strong>“Allora basta conoscere la password del router e puoi leggere tutto…“.</strong> E ancora no! Il problema è che questi nuovi protocolli di sicurezza fanno in modo che una volta che il computer si è connesso alla rete wifi, crei una password unica tra lui e il router ed usi quella, proprio per evitare che qualcu’altro della rete intercetti il traffico.</p> <p>E allora come fa Bettercap a fare intereccetare il tutto al computer su cui è eseguito? <strong>Bettercap riesce forzare il computer del mio coinquilino a spedire i pacchetti che dovrebbero essere destinati al router a me</strong> e quindi, potendoli, tendenzialmente, decifrare, puoi farci un po’ tutto quello che vuoi. Cioè, detto in altre parole, crea la situazione chiamata man-in-the-middle (MITM). Tendenzialmente perchè in realtà poi c’è di mezzo l’<em>https</em>, quindi… un passo alla volta.</p> <p>Quindi, siamo arrivati al punto in cui, il mio coinquilino, o meglio il suo computer, spedisce i pacchetti internet a me invece che al router.</p> <p>Come fa Bettercap a dire al pc del mio coinquilino di spedire pacchetti a me? Praticamente succede questo, all’interno della rete, ogni dispositivo si crea una tabella, chiamata <em>tabella ARP</em>.</p> <p>Questa tabella serve per fare in modo che un pacchetto internet (contrassegnato con un IP specifico) venga spedito al reale destinatario. L’indirizzo IP difatto è una targa “temporanea”, virtuale, che domani può cambiare, mentre ogni scheda di rete ha un indirizzo MAC che rimane sempre lo stesso (ora, anche qui non è propriamente vero che resta sempre uguale, si può cambiare, ma tendenzialemnte resta sempre lo stesso) e viene usato per identificare realmente a quale dispositivo bisogna mandare i pacchetti.</p> <div class="notice"> <h3>Come vedere la tabella ARP del tuo pc</h3> Per vedere la tabella ARP del tuo computer UNIX (cioè Linux, Mac o altre cosette meno conosciute), basta dare il comando <i>arp -a</i>. Vedrete quindi la tabella di tutti i dispositivi che il tuo computer conosce e a cui ha associato l'indirizzo IP al rispettivo MAC Address. Se non vedete tutti i dispositivi della rete probabilmente è perchè il vostro dispositivo non ha mai interagito con quelli mancanti nella tabella. Un semplice <i>ping IP_MANCANTE</i> dovrebbe risolvere il problema. </div> <p>Il problema di questa tabella, che permette a Bettercap di far funzionare il tutto, è che ogni dispositivo può mandare messaggi nella rete in <em>broadcast</em> che di fatto sono coppie &lt;IP, MAC address&gt; dove l’IP può essere qualsiasi cosa, non per forza quello a lui realmente assegnato e non vi è autenticazione per garantire che questo avvenga solo per chi ne ha realemnte diritto. E quindi il computer su cui è eseguito Bettercap (supponiamo abbia indirizzo MAC 00:00:00:ZZ:ZZ:ZZ e indirizzo IP 192.168.1.72) manda nella rete i seguenti pacchetti:</p> <ul> <li>&lt;192.168.1.1, 00:00:00:ZZ:ZZ:ZZ&gt;</li> <li>&lt;192.168.1.2, 00:00:00:ZZ:ZZ:ZZ&gt;</li> <li>&lt;192.168.1.3, 00:00:00:ZZ:ZZ:ZZ&gt;</li> <li>&lt;192.168.1.4, 00:00:00:ZZ:ZZ:ZZ&gt; …</li> </ul> <p>e così via per tutti gli indirizzi IP presenti nella rete. D’ora in avanti, quindi, tutti i computer che credono quei messaggi autentici manderanno al computer con Bettercap i pacchetti destinati al router (che sarà uno di quegli indirizzi IP, di solito 192.168.1.1 o 192.168.1.254) e Bettercap potrà analizzarli senza problemi in quanto transitano sulla scheda di rete a cui ha accesso.</p> <p>‘Na ficata no?!</p> <h3 id="difesa-e-raggiri">Difesa e raggiri</h3> <p>Come sempre, a ogni vulnerabilità si cerca un rimedio. Effettivamente esistono numerosi programmi online che bloccano gli indirizzi IP che cercano di inondare la rete con pacchetti ARP <em>melevoli</em>. Se ci pensate è abbastanza semplice, se un indirizzo MAC dichiara di essere tutti gli indirizzi IP della rete c’è qualcosa che non va…</p> <p>Nel caso il vostro router abbia una qualche protezione di questo genere, è possibile, con Bettercap, cercare di intercettare, con l’<em>ARP poisoning</em>, quella tecnica appena vista, solo il dispositivo <em>target</em>, in tal caso, l’attacco effettuato sarà <em>half-duplex</em>.</p> <p>Se poi, ancora una volta questa cosa non dovesse funzionare perchè il dispositivo <em>target</em> a sua volta controlla i pacchetti ARP, è possibile cambiare metodologia e passare ad un attacco basato sul protocollo ICMP, di cui trovate maggior informazioni direttamente nella documentazione del tool.</p> <h2 id="bettercap">Bettercap</h2> <p>Arriviamo al dunque, come fare tutto questo con Bettercap?</p> <div class="highlighter-rouge"><pre class="highlight"><code>sudo bettercap -s
</code></pre></div> <p>Capite perchè da così tante soddisfazioni, semplicemente con <code class="highlighter-rouge">-s</code> lui fa tutte quelle cose lì.</p> <p>Ci sono poi varie opzioni annesse, ad esempio</p> <div class="highlighter-rouge"><pre class="highlight"><code>sudo bettercap -s arp --full-duplex
</code></pre></div> <p>che manda quei pacchetti per dirottare il traffico sia al <em>target</em> che al router (contrariamente effettua un attacco <em>half-duplex</em> citato prima), potendo così vedere la botta e risposta completa, le pagine richieste e quelle ricevute dalla rete.</p> <p><img src="https://www.dreamgroup.it/wp-content/uploads/2017/01/CKe4csi.png" alt="https"></p> <h1 id="e-la-cifratura">E la cifratura?</h1> <p>Come potete immaginare, chiaramente, non è proprio così semplice poi nella realtà. Certo, abbiamo visto come reindirizzare il traffico della rete sul nostro PC e analizzarlo ma… se questi pacchetti che ci arrivano sono cifrati tra il <em>target</em> e il <em>server</em> (leggi, sito web a cui mi connetto), posso intercettarli quanto voglio ma non sarò in grado di leggerli. E questa è quasi la totalità dei casi, ogni qual volta il sito a cui il destinatario si connette è in <em>https</em>.</p> <p>E quindi, non ci arrendiamo mica… Bettercap ci viene nuovamente in aiuto con varie tecniche, la più semplice è l’<em>ssl-strip</em>.</p> <h2 id="ssl-strip">SSL STRIP</h2> <p>Questa tecnica è stata introdotta da Moxie Marlinspike nel 2009 e consiste nel sostituire i link che dovrebbero essere sicuro con altri di cui abbiamo il controllo. Mi spiego meglio.</p> <ul> <li>Tiziano (il nostro Target) apre un sito in http, i cui contenuti non sono quindi cifrati</li> <li>Intercettata quindi questa pagina, si sostituiscono tutti i suoi link interni con altri link, banalmente togliendo la <em>s</em> di <em>https</em>.</li> <li>Si inoltra il pacchetto pulito dai link che poterebbero a pagine cifrate e si continua come sempre</li> </ul> <p>Questa cosa funziona, chiaramente, se la primissima pagina non è cifrata, altrimenti non siamo in grado di <em>“pulire”</em> il link.</p> <p>Quindi ora fate un test, andate sulla pagina di Google connettendovi tramite http, cioè scrivete nel browser <em>http://google.it</em>. Con altissima probabilità verrete reindirizzati alla pagina cifrata, tutta colpa di HSTS.</p> <h3 id="hsts">HSTS</h3> <p>HTTP Strict Transport Security (HSTS) è un protocollo con cui il server può dire al browser che cerca di visitarlo che lui accetta solo connessioni cifrate, proprio per evitare attacchi come quelli appena descritti sopra. E allora?</p> <p>E allora ecco la soluzione, introdotta da Leonardo Nve Egea al BlackHat Asia 2014. Poichè la politica HSTS si applica a specifici domini per lo più, basta sostituire il dominio e così, il link <code class="highlighter-rouge">https://wwww.facebook.com</code> viene modificato in <code class="highlighter-rouge">https://wwww.facebook.com</code>. Certo, qualcuno potrebbe accorgersene ma quanti di voi contano quante <code class="highlighter-rouge">w</code> ci sono quando aprite ogni link?</p> <p>E ora? E ora quel <code class="highlighter-rouge">wwww.facebook.com</code> deve essere risolto da qualche DNS, ma chiaramente nessuno può risolverlo. Ma dov’è il problema, tanto tutto il traffico passa per il computer attaccante, può farsi lui di risolvere il dominio, aprire la connessione cifrata con il sito e rigirare il pacchetto decifrato al <em>target</em>.</p> <h2 id="ancora-meglio">Ancora meglio?</h2> <p>Beh, Bettercap permette di fare anche di più, permette di installare un certificare di sicurezza e comunicare in HTTPS con il <em>target</em> così che il tutto diventa ancora più complesso da verificare, ma anche tutto più complesso da raccontarvi ora.</p> <p>Vuoi provare? Avvia Bettercap con queste opzioni:</p> <div class="highlighter-rouge"><pre class="highlight"><code>sudo bettercap -T IP_CELLULARE --proxy 
</code></pre></div> <p>Ora prendi il tuo cellulare, vai nella Home di questo sito (che è senza <em>http</em>, perchè aihmè, se lo fanno pagare) e quindi clicca sull’icona di LinkedIn. Come vedrai sarai su qualcosa come <em>wwwww.linkedin.it/…</em> (a me ne mostra 5 di <em>w</em>), e sarete in grado di vedere il traffico generato senza che questo sia cifrato.</p> <h4 id="cosa-possiamo-imparare">Cosa possiamo imparare?</h4> <p>Occhio a quando non siete in <em>https</em>!!</p> <h1 id="installazione">Installazione</h1> <p>Si può facilemnte installare in vari modi, tra cui</p> <div class="highlighter-rouge"><pre class="highlight"><code>gem install bettercap
</code></pre></div> <p>o seguendo la <a href="https://www.bettercap.org/index.html#document-install">documentazione</a>.</p> <p>Una volta installato non dovete far altro che avviarlo, da terminale, con il seguente comando</p> <div class="highlighter-rouge"><pre class="highlight"><code>sudo bettercap -T 192.168.1.10 -X -I interfaccia
</code></pre></div> <p>dove -T IP (opzionale) rappresenta l’IP di cui volete intercettare il traffico, <em>interfaccia</em> è il nome dell’interfaccia su cui attivate il tutto, ad esempio la mia interfaccia wifi è en1, puoi scoprire la tua con un <code class="highlighter-rouge">ifconfig</code>.</p> <p>Per il resto la <a href="https://www.bettercap.org/index.html">documentazione</a> ufficiale è molto chiara, quindi potete andare direttamente lì per leggere le mille opzioni previste e usarle.</p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://apagiaro.it/tags/#crittografia" title="Pages tagged crittografia" class="tag"><span class="term">crittografia</span></a><a href="https://apagiaro.it/tags/#MITM" title="Pages tagged MITM" class="tag"><span class="term">MITM</span></a><a href="https://apagiaro.it/tags/#sicurezza" title="Pages tagged sicurezza" class="tag"><span class="term">sicurezza</span></a><a href="https://apagiaro.it/tags/#bettercap" title="Pages tagged bettercap" class="tag"><span class="term">bettercap</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://apagiaro.it/bettercap-guida-ita/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://apagiaro.it/bettercap-guida-ita/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://apagiaro.it/bettercap-guida-ita/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="https://apagiaro.it/assets/js/jquery-1.12.0.min.js"></script> <script src="https://apagiaro.it/assets/js/jquery.dlmenu.min.js"></script> <script src="https://apagiaro.it/assets/js/jquery.goup.min.js"></script> <script src="https://apagiaro.it/assets/js/jquery.magnific-popup.min.js"></script> <script src="https://apagiaro.it/assets/js/jquery.fitvid.min.js"></script> <script src="https://apagiaro.it/assets/js/scripts.js"></script> <!-- Asynchronous Google Analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-105829132-1', 'auto'); ga('require', 'linkid', 'linkid.js'); ga('send', 'pageview'); </script> <script type="text/javascript"> var disqus_shortname = 'alessandro308'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
